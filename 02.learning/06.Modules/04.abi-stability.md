# Table of Contents

- [ABI 안정성](#abi-안정성)
  - [소개](#소개)
  - [Node.js의 ABI 안정성](#nodejs의-abi-안정성)
  - [N-API](#n-api)

# ABI 안정성

## 소개

애플리케이션 바이너리 인터페이스(Application Binary Interface, ABI)는 프로그램이 다른 컴파일된 프로그램의 함수를 호출하고 데이터 구조를 사용하는 방식이다. ABI는 애플리케이션 프로그래밍 인터페이스(Application Programming Interface, API)를 컴파일한 결과물이다. 즉, 클래스, 함수, 데이터 구조, 열거형, 상수 등을 설명하는 헤더 파일은 컴파일 과정을 통해 실제 메모리 주소, 매개변수 값, 메모리 구조의 크기와 배치로 변환된다.

ABI를 사용하는 애플리케이션은 ABI 제공자가 컴파일한 것과 동일한 주소, 매개변수 값, 메모리 구조의 크기와 배치를 사용하도록 컴파일해야 한다. 이는 일반적으로 ABI 제공자가 제공하는 헤더를 기반으로 컴파일하여 달성한다.

ABI 제공자와 사용자는 서로 다른 시점에 다른 버전의 컴파일러로 컴파일할 수 있다. 따라서 ABI 호환성을 보장하는 책임의 일부는 컴파일러에 있다. 서로 다른 벤더가 제공하는 다양한 버전의 컴파일러는 동일한 내용의 헤더 파일로부터 같은 ABI를 생성해야 한다. 또한 헤더에 설명된 API를 ABI 규칙에 따라 접근하는 코드를 생성해야 한다. 현대의 컴파일러들은 컴파일하는 애플리케이션의 ABI 호환성을 깨지 않는 데 상당히 좋은 성과를 보여주고 있다.

ABI 호환성을 보장하는 나머지 책임은 API를 제공하는 헤더 파일을 관리하는 팀에 있다. 헤더 파일은 수정할 수 있지만, 변경 사항이 기존 ABI 사용자와의 호환성을 해치지 않도록 신중하게 추적해야 한다.

## Node.js의 ABI 안정성

Node.js는 여러 독립적인 팀이 관리하는 헤더 파일을 제공한다. 예를 들어 `node.h`와 `node_buffer.h` 같은 헤더 파일은 Node.js 팀이 관리한다. `v8.h`는 V8 팀이 관리하는데, V8 팀은 Node.js 팀과 긴밀히 협력하지만 독립적으로 운영되며 자체적인 일정과 우선순위를 가지고 있다. 따라서 Node.js 팀은 프로젝트가 제공하는 헤더의 변경 사항을 부분적으로만 통제할 수 있다. 이러한 이유로 Node.js 프로젝트는 [시맨틱 버저닝](https://semver.org/)을 채택했다. 이를 통해 프로젝트가 제공하는 API는 하나의 주 버전 내의 모든 부 버전과 패치 버전에서 안정적인 ABI를 제공한다. 실제로 이는 특정 주 버전의 Node.js에 대해 컴파일된 Node.js 네이티브 애드온이 동일한 주 버전 내의 모든 부 버전이나 패치 버전에서 성공적으로 로드될 것임을 보장한다는 의미다.

## N-API

Node.js에 여러 주 버전에 걸쳐 안정적으로 유지되는 ABI를 제공하는 API에 대한 수요가 생겼다. 이러한 API를 만들게 된 동기는 다음과 같다:

- JavaScript 언어는 초기부터 자체적인 호환성을 유지해왔다. 반면 JavaScript 코드를 실행하는 엔진의 ABI는 Node.js의 모든 주 버전마다 변경된다. 이는 순수하게 JavaScript로 작성된 Node.js 패키지로 구성된 애플리케이션은 새로운 주 버전의 Node.js가 프로덕션 환경에 도입되더라도 재컴파일, 재설치, 재배포할 필요가 없다는 것을 의미한다. 반대로 네이티브 애드온이 포함된 패키지에 의존하는 애플리케이션은 새로운 주 버전의 Node.js가 프로덕션 환경에 도입될 때마다 재컴파일, 재설치, 재배포해야 한다. 네이티브 애드온이 포함된 Node.js 패키지와 순수 JavaScript로 작성된 패키지 간의 이러한 차이는 네이티브 애드온에 의존하는 프로덕션 시스템의 유지보수 부담을 가중시켰다.

- 다른 프로젝트들이 본질적으로 Node.js의 대체 구현인 JavaScript 인터페이스를 만들기 시작했다. 이러한 프로젝트들은 보통 V8과 다른 JavaScript 엔진을 기반으로 구축되므로, 네이티브 애드온은 필연적으로 다른 구조를 가지고 다른 API를 사용한다. 그럼에도 불구하고 네이티브 애드온에 대해 단일 API를 사용하면, Node.js JavaScript API의 다른 구현체들도 Node.js를 중심으로 형성된 JavaScript 패키지 생태계를 활용할 수 있다.

- Node.js가 향후 다른 JavaScript 엔진을 포함할 수 있다. 이는 외부적으로는 모든 Node.js 인터페이스가 동일하게 유지되지만 V8 헤더 파일이 없어진다는 것을 의미한다. Node.js가 JavaScript 엔진에 구애받지 않는 API를 먼저 제공하고 네이티브 애드온이 이를 채택하지 않는다면, 이러한 변화는 전반적인 Node.js 생태계, 특히 네이티브 애드온의 혼란을 초래할 수 있다.

이러한 목적을 위해 Node.js는 버전 8.6.0에서 N-API를 도입했고, Node.js 8.12.0부터 프로젝트의 안정적인 구성 요소로 표시했다. API는 [`node_api.h`][]와 [`node_api_types.h`][] 헤더에 정의되어 있으며, Node.js 주 버전 경계를 넘어서는 전방 호환성을 보장한다. 이 보장은 다음과 같이 설명할 수 있다:

**N-API의 특정 버전 _n_은 해당 버전이 발표된 Node.js의 주 버전과 이후의 모든 버전(후속 주 버전 포함)에서 사용할 수 있다.**

네이티브 애드온 작성자는 `node_api.h`에 정의된 API와 `node_api_types.h`에 정의된 데이터 구조 및 상수만 사용하도록 함으로써 N-API의 전방 호환성 보장을 활용할 수 있다. 이렇게 함으로써 작성자는 자신의 네이티브 애드온을 프로젝트에 추가하는 것이 순수 JavaScript로 작성된 패키지를 추가하는 것보다 프로덕션 사용자의 유지보수 부담을 더 증가시키지 않는다는 것을 알려줄 수 있다.

N-API는 새로운 API가 수시로 추가되기 때문에 버전 관리가 이루어진다. 시맨틱 버저닝과 달리 N-API 버전 관리는 누적적이다. 즉, 각 N-API 버전은 semver 시스템의 부 버전과 같은 의미를 가지며, N-API에 대한 모든 변경은 이전 버전과 호환된다. 또한 새로운 N-API는 커뮤니티가 프로덕션 환경에서 이를 검증할 기회를 제공하기 위해 실험적 플래그 하에 추가된다. 실험적 상태란 향후 ABI 비호환 방식으로 수정하지 않도록 주의를 기울였지만, 설계된 대로 정확하고 유용하다는 것이 프로덕션에서 충분히 입증되지 않았으며, N-API의 다가오는 버전에 최종적으로 통합되기 전에 ABI 비호환 변경을 겪을 수 있다는 것을 의미한다. 즉, 실험적 N-API는 아직 전방 호환성 보장이 적용되지 않는다.

[`node_api.h`]: https://github.com/nodejs/node/blob/main/src/node_api.h
[`node_api_types.h`]: https://github.com/nodejs/node/blob/main/src/node_api_types.h