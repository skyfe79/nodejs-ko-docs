# Table of Contents

- [ABI Stability](#abi-stability)
  - [소개](#소개)
  - [Node.js의 ABI 안정성](#nodejs의-abi-안정성)
  - [N-API](#n-api)

# [ABI Stability](https://nodejs.org/en/learn/modules/publishing-a-package#abi-stability)





## 소개

애플리케이션 바이너리 인터페이스(ABI)는 프로그램이 다른 컴파일된 프로그램의 함수를 호출하고 데이터 구조를 사용할 수 있게 해주는 방법입니다. 이는 애플리케이션 프로그래밍 인터페이스(API)의 컴파일된 버전이라고 할 수 있습니다. 즉, 애플리케이션이 원하는 작업을 수행할 수 있도록 클래스, 함수, 데이터 구조, 열거형, 상수를 설명하는 헤더 파일은 컴파일을 통해 ABI 제공자가 컴파일한 주소, 예상 매개변수 값, 메모리 구조 크기 및 레이아웃과 일치합니다.

ABI를 사용하는 애플리케이션은 사용 가능한 주소, 예상 매개변수 값, 메모리 구조 크기 및 레이아웃이 ABI 제공자가 컴파일한 것과 일치하도록 컴파일되어야 합니다. 이는 일반적으로 ABI 제공자가 제공한 헤더 파일을 기준으로 컴파일함으로써 달성됩니다.

ABI 제공자와 ABI 사용자가 서로 다른 시점에 서로 다른 버전의 컴파일러로 컴파일될 수 있기 때문에, ABI 호환성을 보장하는 일부 책임은 컴파일러에 있습니다. 서로 다른 공급자가 제공한 컴파일러의 다른 버전들은 특정 내용의 헤더 파일에서 동일한 ABI를 생성해야 하며, 헤더 파일에 설명된 API에 접근하는 코드를 ABI의 규칙에 따라 생성해야 합니다. 모던 컴파일러들은 컴파일하는 애플리케이션의 ABI 호환성을 깨뜨리지 않는 데 있어 상당히 좋은 성과를 보여주고 있습니다.

ABI 호환성을 보장하는 나머지 책임은 컴파일 시 안정적인 ABI를 제공하는 API를 정의하는 헤더 파일을 유지하는 팀에 있습니다. 헤더 파일을 변경할 수는 있지만, 변경 사항의 성격을 면밀히 추적하여 컴파일 시 기존 ABI 사용자들이 새 버전과 호환되지 않도록 해야 합니다.


## Node.js의 ABI 안정성

Node.js는 여러 독립적인 팀이 관리하는 헤더 파일을 제공합니다. 예를 들어, `node.h`와 `node_buffer.h` 같은 헤더 파일은 Node.js 팀이 관리합니다. `v8.h`는 V8 팀이 관리하며, 이 팀은 Node.js 팀과 긴밀히 협력하지만 독립적으로 운영되고 자체 일정과 우선순위를 가지고 있습니다. 따라서 Node.js 팀은 프로젝트에서 제공하는 헤더 파일의 변경 사항을 부분적으로만 통제할 수 있습니다. 이에 따라 Node.js 프로젝트는 [시맨틱 버저닝](https://semver.org/)을 채택했습니다. 이를 통해 프로젝트가 제공하는 API는 하나의 메이저 버전 내에서 출시된 모든 마이너 및 패치 버전의 Node.js에서 안정적인 ABI를 보장합니다. 실제로 이는 Node.js 네이티브 애드온이 특정 메이저 버전의 Node.js에 대해 컴파일된 경우, 해당 메이저 버전 내의 어떤 마이너 또는 패치 버전의 Node.js에서도 성공적으로 로드될 것임을 보장한다는 의미입니다.


## [N-API](https://nodejs.org/en/learn/modules/publishing-a-package#n-api)

Node.js에 여러 주요 버전에서 안정적인 ABI를 제공하는 API를 추가해야 한다는 요구가 생겼습니다. 이러한 API를 만든 이유는 다음과 같습니다:

-   자바스크립트 언어는 초기부터 자기 자신과 호환성을 유지해 왔지만, 자바스크립트 코드를 실행하는 엔진의 ABI는 Node.js의 주요 버전이 바뀔 때마다 변경됩니다. 이는 순수 자바스크립트로 작성된 Node.js 패키지로 구성된 애플리케이션은 Node.js의 새로운 주요 버전이 프로덕션 환경에 도입되더라도 재컴파일, 재설치, 재배포가 필요하지 않음을 의미합니다. 반면, 네이티브 애드온이 포함된 패키지에 의존하는 애플리케이션은 Node.js의 새로운 주요 버전이 도입될 때마다 재컴파일, 재설치, 재배포를 해야 합니다. 네이티브 애드온이 포함된 Node.js 패키지와 순수 자바스크립트로 작성된 패키지 간의 이러한 차이는 네이티브 애드온에 의존하는 프로덕션 시스템의 유지 보수 부담을 증가시켰습니다.
    
-   다른 프로젝트들이 Node.js의 대체 구현체인 자바스크립트 인터페이스를 만들기 시작했습니다. 이러한 프로젝트는 일반적으로 V8과 다른 자바스크립트 엔진을 기반으로 하기 때문에, 네이티브 애드온은 다른 구조를 가지며 다른 API를 사용합니다. 그러나 Node.js 자바스크립트 API의 다양한 구현체에서 동일한 API를 사용한다면, 이러한 프로젝트들도 Node.js 주변에 형성된 자바스크립트 패키지 생태계를 활용할 수 있습니다.
    
-   Node.js는 미래에 다른 자바스크립트 엔진을 포함할 수 있습니다. 이는 외부적으로는 모든 Node.js 인터페이스가 동일하게 유지되지만, V8 헤더 파일이 없어질 수 있음을 의미합니다. 이러한 변화는 자바스크립트 엔진에 독립적인 API가 Node.js에 의해 먼저 제공되고 네이티브 애드온에 의해 채택되지 않는다면, Node.js 생태계 전반, 특히 네이티브 애드온에 큰 혼란을 초래할 수 있습니다.
    

이러한 목적을 위해 Node.js는 버전 8.6.0에서 N-API를 도입했으며, Node.js 8.12.0부터는 안정적인 컴포넌트로 표시했습니다. 이 API는 [`node_api.h`](https://github.com/nodejs/node/blob/main/src/node_api.h)와 [`node_api_types.h`](https://github.com/nodejs/node/blob/main/src/node_api_types.h) 헤더 파일에 정의되어 있으며, Node.js 주요 버전 간의 **전방 호환성**을 보장합니다. 이 보장은 다음과 같이 설명할 수 있습니다:

**N-API의 특정 버전 *n*은 해당 버전이 출시된 Node.js 주요 버전과 이후의 모든 버전(주요 버전 포함)에서 사용 가능합니다.**

네이티브 애드온 개발자는 `node_api.h`에 정의된 API와 `node_api_types.h`에 정의된 데이터 구조 및 상수만 사용함으로써 N-API의 전방 호환성 보장을 활용할 수 있습니다. 이를 통해 개발자는 프로덕션 사용자에게 순수 자바스크립트로 작성된 패키지를 추가할 때와 동일한 수준의 유지 보수 부담만 증가한다는 것을 알려 애드온의 채택을 용이하게 할 수 있습니다.

N-API는 새로운 API가 추가될 때마다 버전이 지정됩니다. 시맨틱 버저닝과 달리 N-API 버저닝은 누적적입니다. 즉, N-API의 각 버전은 시맨틱 버저닝 시스템에서 마이너 버전과 동일한 의미를 가지며, N-API에 대한 모든 변경 사항은 하위 호환성을 유지합니다. 또한, 새로운 N-API는 실험적 플래그 아래에 추가되어 커뮤니티가 프로덕션 환경에서 이를 검증할 기회를 제공합니다. 실험적 상태는 새로운 API가 ABI 호환성을 해치지 않도록 설계되었지만, 아직 프로덕션 환경에서 충분히 검증되지 않았으며, 따라서 최종적으로 N-API의 향후 버전에 통합되기 전에 ABI 호환성을 해치는 변경이 발생할 수 있음을 의미합니다. 즉, 실험적 N-API는 아직 전방 호환성 보장에 포함되지 않습니다.


